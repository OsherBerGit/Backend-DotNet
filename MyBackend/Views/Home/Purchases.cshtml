@{
    ViewData["Title"] = "Purchases";
}

<div class="flex-between mb-2">
    <h1>Purchases Management</h1>
    <button class="btn btn-primary" onclick="openCreateModal()">+ Create Purchase</button>
</div>

<div id="alert-container"></div>

<div class="table-container">
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Loading purchases...</p>
    </div>

    <table id="purchases-table" style="display: none;">
        <thead>
            <tr>
                <th>ID</th>
                <th>User ID</th>
                <th>Date</th>
                <th>Items Count</th>
                <th>Total</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="purchases-body">
        </tbody>
    </table>
</div>

<!-- Create Purchase Modal -->
<div id="purchase-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>Create New Purchase</h2>
        <form id="purchase-form" onsubmit="savePurchase(event)">
            <div class="form-group">
                <label for="purchase-user">User *</label>
                <select id="purchase-user" required>
                    <option value="">Select User...</option>
                </select>
            </div>

            <div class="form-group">
                <label>Purchase Items</label>
                <div id="purchase-items">
                    <!-- Items will be added here -->
                </div>
                <button type="button" class="btn btn-small" onclick="addPurchaseItem()">+ Add Item</button>
            </div>

            <div class="form-group">
                <label>Estimated Total: <span id="estimated-total">$0.00</span></label>
            </div>

            <div class="flex gap-1">
                <button type="submit" class="btn btn-primary">Create Purchase</button>
                <button type="button" class="btn" onclick="closeModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- View Purchase Details Modal -->
<div id="details-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeDetailsModal()">&times;</span>
        <h2>Purchase Details</h2>
        <div id="purchase-details"></div>
        <button type="button" class="btn" onclick="closeDetailsModal()">Close</button>
    </div>
</div>

@section Scripts {
    <script>
        let purchases = [];
        let users = [];
        let products = [];
        let purchaseItems = [];

        window.addEventListener('DOMContentLoaded', async () => {
            await Promise.all([loadPurchases(), loadUsers(), loadProducts()]);
        });

        async function loadPurchases() {
            try {
                const response = await fetch('/api/purchase');
                purchases = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('purchases-table').style.display = 'table';
                
                renderPurchases();
            } catch (error) {
                console.error('Error loading purchases:', error);
                showAlert('Failed to load purchases', 'error');
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/user');
                users = await response.json();
                populateUserSelect();
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        async function loadProducts() {
            try {
                const response = await fetch('/api/product');
                products = await response.json();
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        function renderPurchases() {
            const tbody = document.getElementById('purchases-body');
            tbody.innerHTML = purchases.map(purchase => `
                <tr>
                    <td>${purchase.id}</td>
                    <td>${purchase.userId}</td>
                    <td>${new Date(purchase.date).toLocaleDateString()}</td>
                    <td><span class="badge badge-success">${purchase.items.length}</span></td>
                    <td><strong>$${purchase.total.toFixed(2)}</strong></td>
                    <td>
                        <button class="btn btn-small btn-primary" onclick="viewPurchase(${purchase.id})">View</button>
                        <button class="btn btn-small btn-danger" onclick="deletePurchase(${purchase.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function populateUserSelect() {
            const select = document.getElementById('purchase-user');
            select.innerHTML = '<option value="">Select User...</option>' +
                users.map(user => `<option value="${user.id}">${user.username} (${user.email})</option>`).join('');
        }

        function openCreateModal() {
            document.getElementById('purchase-form').reset();
            purchaseItems = [];
            document.getElementById('purchase-items').innerHTML = '';
            addPurchaseItem(); // Add one item by default
            document.getElementById('purchase-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('purchase-modal').classList.remove('active');
        }

        function closeDetailsModal() {
            document.getElementById('details-modal').classList.remove('active');
        }

        function addPurchaseItem() {
            const itemId = Date.now();
            const itemDiv = document.createElement('div');
            itemDiv.className = 'form-group';
            itemDiv.id = `item-${itemId}`;
            itemDiv.innerHTML = `
                <div style="border: 1px solid var(--border-color); padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                    <div class="flex-between">
                        <strong>Item #${purchaseItems.length + 1}</strong>
                        <button type="button" class="btn btn-small btn-danger" onclick="removePurchaseItem(${itemId})">Remove</button>
                    </div>
                    <div class="form-group">
                        <label>Product</label>
                        <select class="item-product" data-item-id="${itemId}" onchange="updateEstimatedTotal()" required>
                            <option value="">Select Product...</option>
                            ${products.map(p => `<option value="${p.id}" data-price="${p.price}">${p.name} - $${p.price.toFixed(2)} (Stock: ${p.quantity})</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" class="item-quantity" data-item-id="${itemId}" min="1" value="1" onchange="updateEstimatedTotal()" required>
                    </div>
                </div>
            `;
            document.getElementById('purchase-items').appendChild(itemDiv);
            purchaseItems.push(itemId);
        }

        function removePurchaseItem(itemId) {
            document.getElementById(`item-${itemId}`).remove();
            purchaseItems = purchaseItems.filter(id => id !== itemId);
            updateEstimatedTotal();
        }

        function updateEstimatedTotal() {
            let total = 0;
            document.querySelectorAll('.item-product').forEach(select => {
                const quantity = document.querySelector(`.item-quantity[data-item-id="${select.dataset.itemId}"]`).value;
                const option = select.options[select.selectedIndex];
                const price = parseFloat(option.dataset.price || 0);
                total += price * parseInt(quantity || 0);
            });
            document.getElementById('estimated-total').textContent = `$${total.toFixed(2)}`;
        }

        async function savePurchase(event) {
            event.preventDefault();

            const userId = parseInt(document.getElementById('purchase-user').value);
            const items = [];

            document.querySelectorAll('.item-product').forEach(select => {
                const productId = parseInt(select.value);
                const quantity = parseInt(document.querySelector(`.item-quantity[data-item-id="${select.dataset.itemId}"]`).value);
                if (productId && quantity) {
                    items.push({ productId, quantity });
                }
            });

            if (items.length === 0) {
                showAlert('Please add at least one item', 'error');
                return;
            }

            const data = { userId, items };

            try {
                const response = await fetch('/api/purchase', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showAlert('Purchase created successfully!', 'success');
                    closeModal();
                    await loadPurchases();
                    await loadProducts(); // Reload to see updated quantities
                } else {
                    const error = await response.text();
                    showAlert('Failed to create purchase: ' + error, 'error');
                }
            } catch (error) {
                console.error('Error creating purchase:', error);
                showAlert('Failed to create purchase', 'error');
            }
        }

        function viewPurchase(id) {
            const purchase = purchases.find(p => p.id === id);
            if (!purchase) return;

            const user = users.find(u => u.id === purchase.userId);
            const detailsHtml = `
                <div class="form-group">
                    <strong>Purchase ID:</strong> ${purchase.id}<br>
                    <strong>User:</strong> ${user ? user.username : purchase.userId}<br>
                    <strong>Date:</strong> ${new Date(purchase.date).toLocaleString()}<br>
                    <strong>Total:</strong> $${purchase.total.toFixed(2)}
                </div>
                <h3>Items:</h3>
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${purchase.items.map(item => `
                            <tr>
                                <td>${item.productName}</td>
                                <td>$${item.price.toFixed(2)}</td>
                                <td>${item.quantity}</td>
                                <td><strong>$${item.subtotal.toFixed(2)}</strong></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('purchase-details').innerHTML = detailsHtml;
            document.getElementById('details-modal').classList.add('active');
        }

        async function deletePurchase(id) {
            if (!confirm('Are you sure you want to delete this purchase? Product quantities will be restored.')) return;

            try {
                const response = await fetch(`/api/purchase/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showAlert('Purchase deleted successfully!', 'success');
                    await loadPurchases();
                    await loadProducts(); // Reload to see updated quantities
                } else {
                    showAlert('Failed to delete purchase', 'error');
                }
            } catch (error) {
                console.error('Error deleting purchase:', error);
                showAlert('Failed to delete purchase', 'error');
            }
        }

        function showAlert(message, type) {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert alert-${type === 'success' ? 'success' : 'error'}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 3000);
        }
    </script>
}

