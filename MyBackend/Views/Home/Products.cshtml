@{
    ViewData["Title"] = "Products";
}

<div class="flex-between mb-2">
    <h1>Products Management</h1>
    <button class="btn btn-primary" onclick="openCreateModal()">+ Add Product</button>
</div>

<div id="alert-container"></div>

<div class="table-container">
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Loading products...</p>
    </div>

    <table id="products-table" style="display: none;">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Description</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="products-body">
        </tbody>
    </table>
</div>

<!-- Create/Edit Product Modal -->
<div id="product-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2 id="modal-title">Add New Product</h2>
        <form id="product-form" onsubmit="saveProduct(event)">
            <input type="hidden" id="product-id">
            
            <div class="form-group">
                <label for="product-name">Name *</label>
                <input type="text" id="product-name" required maxlength="100">
            </div>

            <div class="form-group">
                <label for="product-description">Description</label>
                <textarea id="product-description" rows="3"></textarea>
            </div>

            <div class="form-group">
                <label for="product-price">Price *</label>
                <input type="number" id="product-price" step="0.01" min="0" required>
            </div>

            <div class="form-group">
                <label for="product-quantity">Quantity *</label>
                <input type="number" id="product-quantity" min="0" required>
            </div>

            <div class="flex gap-1">
                <button type="submit" class="btn btn-primary">Save</button>
                <button type="button" class="btn" onclick="closeModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        let products = [];

        // Load products on page load
        window.addEventListener('DOMContentLoaded', loadProducts);

        async function loadProducts() {
            try {
                const response = await fetch('/api/product');
                products = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('products-table').style.display = 'table';
                
                renderProducts();
            } catch (error) {
                console.error('Error loading products:', error);
                showAlert('Failed to load products', 'error');
            }
        }

        function renderProducts() {
            const tbody = document.getElementById('products-body');
            tbody.innerHTML = products.map(product => `
                <tr>
                    <td>${product.id}</td>
                    <td><strong>${product.name}</strong></td>
                    <td>${product.description || '-'}</td>
                    <td>$${product.price.toFixed(2)}</td>
                    <td>
                        <span class="badge ${product.quantity > 10 ? 'badge-success' : product.quantity > 0 ? 'badge-warning' : 'badge-danger'}">
                            ${product.quantity}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-small btn-primary" onclick="editProduct(${product.id})">Edit</button>
                        <button class="btn btn-small btn-danger" onclick="deleteProduct(${product.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function openCreateModal() {
            document.getElementById('modal-title').textContent = 'Add New Product';
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            document.getElementById('product-modal').classList.add('active');
        }

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            document.getElementById('modal-title').textContent = 'Edit Product';
            document.getElementById('product-id').value = product.id;
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-description').value = product.description || '';
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-quantity').value = product.quantity;
            document.getElementById('product-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('product-modal').classList.remove('active');
        }

        async function saveProduct(event) {
            event.preventDefault();

            const id = document.getElementById('product-id').value;
            const data = {
                name: document.getElementById('product-name').value,
                description: document.getElementById('product-description').value,
                price: parseFloat(document.getElementById('product-price').value),
                quantity: parseInt(document.getElementById('product-quantity').value)
            };

            try {
                let response;
                if (id) {
                    // Update existing product
                    response = await fetch(`/api/product/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    // Create new product
                    response = await fetch('/api/product', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }

                if (response.ok) {
                    showAlert(`Product ${id ? 'updated' : 'created'} successfully!`, 'success');
                    closeModal();
                    await loadProducts();
                } else {
                    showAlert('Failed to save product', 'error');
                }
            } catch (error) {
                console.error('Error saving product:', error);
                showAlert('Failed to save product', 'error');
            }
        }

        async function deleteProduct(id) {
            if (!confirm('Are you sure you want to delete this product?')) return;

            try {
                const response = await fetch(`/api/product/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showAlert('Product deleted successfully!', 'success');
                    await loadProducts();
                } else {
                    showAlert('Failed to delete product', 'error');
                }
            } catch (error) {
                console.error('Error deleting product:', error);
                showAlert('Failed to delete product', 'error');
            }
        }

        function showAlert(message, type) {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert alert-${type === 'success' ? 'success' : 'error'}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 3000);
        }
    </script>
}

