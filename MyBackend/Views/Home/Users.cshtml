@{
    ViewData["Title"] = "Users";
}

<div class="flex-between mb-2">
    <h1>Users Management</h1>
    <button class="btn btn-primary" onclick="openCreateModal()">+ Add User</button>
</div>

<div id="alert-container"></div>

<div class="table-container">
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Loading users...</p>
    </div>

    <table id="users-table" style="display: none;">
        <thead>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Email</th>
                <th>Roles</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="users-body">
        </tbody>
    </table>
</div>

<!-- Create User Modal -->
<div id="user-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2 id="modal-title">Add New User</h2>
        <form id="user-form" onsubmit="saveUser(event)">
            <div class="form-group">
                <label for="user-username">Username *</label>
                <input type="text" id="user-username" required maxlength="50">
            </div>

            <div class="form-group">
                <label for="user-email">Email *</label>
                <input type="email" id="user-email" required>
            </div>

            <div class="form-group">
                <label for="user-password">Password *</label>
                <input type="password" id="user-password" required minlength="6">
            </div>

            <div class="flex gap-1">
                <button type="submit" class="btn btn-primary">Create User</button>
                <button type="button" class="btn" onclick="closeModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit User Modal -->
<div id="edit-user-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h2>Edit User</h2>
        <form id="edit-user-form" onsubmit="updateUser(event)">
            <input type="hidden" id="edit-user-id">
            
            <div class="form-group">
                <label for="edit-user-email">Email *</label>
                <input type="email" id="edit-user-email" required>
            </div>

            <div class="flex gap-1">
                <button type="submit" class="btn btn-primary">Update</button>
                <button type="button" class="btn" onclick="closeEditModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        let users = [];

        window.addEventListener('DOMContentLoaded', loadUsers);

        async function loadUsers() {
            try {
                const response = await fetch('/api/user');
                users = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('users-table').style.display = 'table';
                
                renderUsers();
            } catch (error) {
                console.error('Error loading users:', error);
                showAlert('Failed to load users', 'error');
            }
        }

        function renderUsers() {
            const tbody = document.getElementById('users-body');
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td><strong>${user.username}</strong></td>
                    <td>${user.email}</td>
                    <td>
                        ${user.roles && user.roles.length > 0 
                            ? user.roles.map(r => `<span class="badge badge-success">${r.name}</span>`).join(' ')
                            : '<span class="badge">No roles</span>'
                        }
                    </td>
                    <td>
                        <button class="btn btn-small btn-primary" onclick="editUser(${user.id})">Edit</button>
                        <button class="btn btn-small btn-danger" onclick="deleteUser(${user.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function openCreateModal() {
            document.getElementById('user-form').reset();
            document.getElementById('user-modal').classList.add('active');
        }

        function editUser(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;

            document.getElementById('edit-user-id').value = user.id;
            document.getElementById('edit-user-email').value = user.email;
            document.getElementById('edit-user-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('user-modal').classList.remove('active');
        }

        function closeEditModal() {
            document.getElementById('edit-user-modal').classList.remove('active');
        }

        async function saveUser(event) {
            event.preventDefault();

            const data = {
                username: document.getElementById('user-username').value,
                email: document.getElementById('user-email').value,
                password: document.getElementById('user-password').value
            };

            try {
                const response = await fetch('/api/user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showAlert('User created successfully!', 'success');
                    closeModal();
                    await loadUsers();
                } else {
                    showAlert('Failed to create user', 'error');
                }
            } catch (error) {
                console.error('Error creating user:', error);
                showAlert('Failed to create user', 'error');
            }
        }

        async function updateUser(event) {
            event.preventDefault();

            const id = document.getElementById('edit-user-id').value;
            const data = {
                email: document.getElementById('edit-user-email').value
            };

            try {
                const response = await fetch(`/api/user/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showAlert('User updated successfully!', 'success');
                    closeEditModal();
                    await loadUsers();
                } else {
                    showAlert('Failed to update user', 'error');
                }
            } catch (error) {
                console.error('Error updating user:', error);
                showAlert('Failed to update user', 'error');
            }
        }

        async function deleteUser(id) {
            if (!confirm('Are you sure you want to delete this user?')) return;

            try {
                const response = await fetch(`/api/user/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showAlert('User deleted successfully!', 'success');
                    await loadUsers();
                } else {
                    showAlert('Failed to delete user', 'error');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showAlert('Failed to delete user', 'error');
            }
        }

        function showAlert(message, type) {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert alert-${type === 'success' ? 'success' : 'error'}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 3000);
        }
    </script>
}

